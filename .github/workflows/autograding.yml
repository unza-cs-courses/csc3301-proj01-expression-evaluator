name: Autograder

on:
  push:
    branches: [main, master]
    tags: ['milestone-*', 'final-*']

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install pytest flake8

    - name: Check for variant config
      id: check_variant
      run: |
        if [ -f ".variant_config.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Variant config found"
          cat .variant_config.json
        elif [ -f "variant.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "variant.json found"
          cat variant.json
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "No variant config found, will generate"
        fi

    - name: Extract student ID and generate variant
      if: steps.check_variant.outputs.exists == 'false'
      run: |
        REPO="${{ github.repository }}"
        STUDENT_ID=$(echo $REPO | rev | cut -d'-' -f1 | rev)
        echo "Generating variant for student: $STUDENT_ID"
        python scripts/generate_variant.py $STUDENT_ID

    - name: Display variant info
      run: |
        echo "=== Variant Configuration ==="
        python scripts/show_variant.py || echo "No variant to display"

    - name: Run visible tests
      run: pytest tests/visible/ -v --tb=short

    - name: Run linter
      run: flake8 src/ --max-line-length=100 || true

    - name: Generate test report
      if: always()
      run: |
        echo "=== Test Summary ==="
        echo "Visible tests completed. Hidden tests will run after deadline."
